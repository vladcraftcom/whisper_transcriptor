# План реализации вкладки “Видео → субтитры (Whisper) → редактирование”

Цель: добавить в приложение отдельную вкладку, которая принимает **видеофайл** (mp4/mkv/…),
извлекает аудио через **ffmpeg**, прогоняет его через локальный **Whisper (whisper.net)**,
генерирует субтитры с таймкодами, и даёт **просмотр + редактирование субтитров поверх видео**
в стиле YouTube (оверлей, без рендера/перекодирования видео).

## Ключевые принципы

- **Не рендерим видео**: субтитры — отдельная сущность, отрисовываем поверх проигрывателя.
- **Редактирование**: правим текст/времена, видим эффект сразу при проигрывании/перемотке.
- **ffmpeg**: используем только для *извлечения/подготовки аудио*, видео не трогаем.
- **Формат субтитров**: делаем “как положено” — **`SRT` для совместимости** + **`WebVTT` как внутренний/доп. формат** (удобнее для редактора и веб‑стиля).

## Принятые решения (по вашим ответам)

- **Вход**: видеофайл (аниме/мультики), **ровно одна аудиодорожка**.
- **Язык по умолчанию**: английский (`en`).
- **Модель по умолчанию**: `medium.en` (английская medium).
- **Хранение результатов**: сохраняем возле **исполняемого файла** (папка `AppContext.BaseDirectory`), а не в `AppData`.
- **Нужно**: загрузка существующих субтитров (`.srt` минимум) и их редактирование.
- **Таймлайн**: под видео нужен горизонтальный ползунок; при перемотке по ползунку субтитры **обязаны** переключаться синхронно с видео.

## Технологический выбор для проигрывания видео в Avalonia

Нужно встроить кроссплатформенный видеоплеер, который отдаёт:
- текущее время (позицию),
- событие изменения позиции,
- возможность seek,
- компонент/контрол для отображения видео в UI.

Рекомендуемый вариант:
- **LibVLCSharp + Avalonia** (кроссплатформенно, зрелый, умеет большинство контейнеров/кодеков).

Альтернативы (хуже по готовности/покрытию кодеков):
- платформенные WebView/HTML5 video (сложнее и нестабильнее по кодекам),
- FFmpeg‑based собственный декодер (это уже “рендер”, вы этого не хотите).

## UI: новая вкладка “Видео”

Добавить `TabControl` на главном окне:
- вкладка **Аудио** (текущая)
- вкладка **Видео**

Вкладка “Видео” (макет):
- **верхняя панель**:
  - “Выбрать видео…”
  - выбор модели (дефолт: `medium.en`)
  - язык (`en/ru/auto/...`, дефолт: `en`)
  - чекбоксы: “Удалять тишину” (опционально), “Сохранять рядом с exe” (по умолчанию включено)
  - “Загрузить субтитры…” (`.srt`/`.vtt`)
  - “Сгенерировать субтитры”
- **левая область**: видеоплеер (LibVLC) + оверлей субтитров
- **ниже/снизу**: таймлайн/скруббер (Slider) + кнопки Play/Pause, текущий таймкод (перемотка ползунком должна обновлять субтитры)
- **правая область**: редактор субтитров
  - таблица сегментов (Start, End, Text)
  - поиск по тексту
  - кнопки: Split, Merge, Delete, Add
  - при выборе строки: jump/seek на Start

## Данные (модель субтитров)

Создать модель:

- `SubtitleSegment`
  - `TimeSpan Start`
  - `TimeSpan End`
  - `string Text`

И коллекцию:
- `ObservableCollection<SubtitleSegment> Segments`

Вычисления:
- `SubtitleSegment? ActiveSegment` (по текущему времени плеера)
- `string ActiveSubtitleText` (для оверлея)

## Извлечение аудио из видео (ffmpeg)

Вариант “стабильно для Whisper”:
- конвертировать сразу в WAV 16kHz mono PCM:

`ffmpeg -y -i "input.mp4" -vn -ac 1 -ar 16000 -c:a pcm_s16le "temp.wav"`

Опционально:
- если включён “удалять тишину”, прогон через `silenceremove` (с фоллбеком без фильтра).

Важно:
- временный WAV хранить в `Path.GetTempPath()`
- после завершения удалять
- лог `ffmpeg` писать в “Лог” вкладки

## Генерация субтитров (Whisper → сегменты)

Текущая интеграция уже собирает только `segment.Text`.
Для субтитров нужно сохранять и тайминги:
- `segment.Start`
- `segment.End`
- `segment.Text`

Пайплайн:
- `processor.ProcessAsync(stream)` → итерация сегментов → наполняем `Segments`.

Далее:
- экспортировать в `SRT`:
  - нумерация 1..N
  - формат времени `HH:MM:SS,mmm`
- также сохранять/поддерживать `VTT`:
  - для совместимости с “ютуб‑стилем” и удобства редактирования

## Оверлей субтитров поверх видео (как YouTube)

Поверх видеоконтрола разместить слой:
- `Border`/`Panel` снизу по центру
- `TextBlock` с `ActiveSubtitleText`
- стиль: фон с полупрозрачностью, крупный шрифт, тень/обводка (читабельно).

Логика обновления:
- таймер/тик (например 10–20 раз/сек) или событие “позиция изменилась”
- на каждом обновлении:
  - `ActiveSegment = FindSegmentByTime(currentTime)`
  - обновить `ActiveSubtitleText`

Поиск сегмента:
- эффективно: индекс “текущий сегмент” + движение вперёд/назад
- или бинарный поиск по `Start`.

## Таймлайн

Элементы:
- `Slider` от 0 до `DurationSeconds`
- `TextBlock` текущего времени / длительности

Поведение:
- при проигрывании обновлять slider (без зацикливания биндинга)
- при перетаскивании slider → `player.Seek(...)` и **немедленно** пересчитать `ActiveSubtitleText` (без ожидания тика таймера)

## Редактирование субтитров

Минимальный функционал:
- редактирование текста в таблице
- редактирование Start/End (в удобном формате, например `00:01:23.456`)
- “прыжок” к сегменту по клику

Расширение:
- кнопка “Split” (разделить сегмент на два в текущей позиции плеера)
- “Merge with next”
- авто‑сдвиг соседей (опционально)

Валидация:
- `Start < End`
- запрет отрицательных
- сортировка по Start (авто‑пересортировать после правок)

## Сохранение/загрузка результатов

Нужно уметь:
- сохранить `*.srt` и `*.vtt` **возле исполняемого файла** (по умолчанию), либо “Сохранить как…”
- загрузить существующий `*.srt`/`*.vtt` и редактировать его

Опционально:
- “проектный файл” (json) с путём видео + сегменты + настройки.

## Потоки выполнения (UX)

- Генерация субтитров — длительная операция:
  - кнопка “Отмена”
  - прогресс (минимум статус + лог)
  - блокировка UI на время процесса (кроме Cancel)

## Этапы реализации (итерации)

### Итерация 1 — UI и видеоплеер
- TabControl, вкладка “Видео”
- встроенный видеоплеер (LibVLC)
- Slider‑таймлайн + Play/Pause

### Итерация 2 — извлечение аудио и Whisper → сегменты
- “Выбрать видео”
- ffmpeg → temp.wav
- whisper → `Segments` (Start/End/Text)
- экспорт `SRT`

### Итерация 3 — оверлей субтитров и синхронизация
- оверлей `ActiveSubtitleText`
- обновление по таймеру/позиции
- переход по сегменту (seek)

### Итерация 4 — редактор сегментов
- таблица сегментов
- редактирование текста/таймингов
- сохранение SRT

### Итерация 5 — улучшения
- split/merge
- “удалять тишину”/фоллбек
- горячие клавиши (Space play/pause, Ctrl+S сохранить)

## Вопросы/уточнения

1) **Плеер**: подтверждаем `LibVLCSharp` как базовый вариант?
2) **Сохранение возле exe**: сохранять субтитры в под‑папку (например `subs/`), или прямо рядом (`videoName.srt`)?
3) **Тайминг‑редактор**: кроме ползунка под видео, нужно ли добавить кнопки “±100ms/±500ms” для выбранного сегмента (ускоряет ручную подгонку)?

